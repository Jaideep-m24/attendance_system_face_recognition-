FROM mambaorg/micromamba:1.5.8

# Make the base env active for every RUN
ARG MAMBA_DOCKERFILE_ACTIVATE=1
SHELL ["/bin/bash", "-lc"]

# Create env
RUN micromamba install -y -n base -c conda-forge \
      python=3.10 dlib=19.24 numpy pip \
  && micromamba clean -a -y

WORKDIR /app

# Install Python deps
COPY --chown=mambauser:mambauser requirements.txt .
RUN python -m pip install --no-cache-dir -r requirements.txt

# Copy the rest
COPY --chown=mambauser:mambauser . .

# (Optional) warm up any model downloads
# RUN python download_models.py || true

ENV PORT=8080 PYTHONUNBUFFERED=1
EXPOSE 8080

# IMPORTANT: run your app inside the conda env
CMD ["micromamba","run","-n","base","gunicorn","-b","0.0.0.0:8080","app:app"]
