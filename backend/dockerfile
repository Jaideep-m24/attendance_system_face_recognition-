FROM mambaorg/micromamba:1.5.8
ARG MAMBA_DOCKERFILE_ACTIVATE=1
SHELL ["/bin/bash", "-lc"]

# conda deps
RUN micromamba install -y -n base -c conda-forge \
      python=3.10 dlib=19.24 opencv numpy pillow pip \
  && micromamba clean -a -y

WORKDIR /app
COPY --chown=mambauser:mambauser requirements.txt .    # put gunicorn here too
RUN python -m pip install --no-cache-dir -r requirements.txt

COPY --chown=mambauser:mambauser . .
RUN python download_models.py || true

ENV PYTHONUNBUFFERED=1 PORT=8080
EXPOSE 8080
CMD ["gunicorn","-w","1","-k","gthread","-t","180","-b","0.0.0.0:8080","app:app"]
