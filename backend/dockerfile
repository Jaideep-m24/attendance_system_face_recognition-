# syntax=docker/dockerfile:1
FROM mambaorg/micromamba:1.5.8

# 1) System + compiled libs via conda (fast, no wheels to compile)
RUN micromamba install -y -n base -c conda-forge \
    python=3.10 dlib=19.24 opencv numpy pillow pip \
 && micromamba clean -a -y

# 2) Work in /app
WORKDIR /app

# 3) Install pure-Python deps with pip (skip ones we already installed via conda)
#    We filter out dlib/opencv/numpy/pillow so pip doesn't try to build them again.
COPY --chown=mambauser:mambauser backend/requirements.txt ./requirements.txt
RUN micromamba run -n base bash -lc '\
  grep -v -E "^(dlib|opencv(-python)?|numpy|pillow)(==.*)?$" requirements.txt > /tmp/reqs.txt && \
  python -m pip install --no-cache-dir -r /tmp/reqs.txt'

# 4) Copy backend code (models are already in the repo)
COPY --chown=mambauser:mambauser backend/ /app/

# 5) Runtime env
ENV PORT=8080 \
    PYTHONUNBUFFERED=1

EXPOSE 8080

# 6) Start Flask app with Gunicorn from the conda env
CMD ["micromamba","run","-n","base","gunicorn","app:app","--bind","0.0.0.0:8080","--workers","2","--threads","4","--timeout","120"]
